# 2026-02-11 - D17 åˆå§‹åŒ–æ¼æ´ï¼ˆå¯å‡çº§/å¯åˆå§‹åŒ–åˆçº¦ï¼‰ï¼šinit å¯è¢«é‡å¤è°ƒç”¨ï¼›æ”»å‡» + ä¿®å¤ï¼ˆinitializerï¼‰

tags: [solidity, security, upgradeable, proxy, initializer, openzeppelin, foundry, audit]

## èƒŒæ™¯ / ç›®æ ‡
ä»Šå¤©å­¦ä¹ å¹¶å¤ç°ä¸€ç±»éå¸¸é«˜é¢‘çš„åˆçº¦æ¼æ´ï¼š**åˆå§‹åŒ–å‡½æ•°ï¼ˆinitialize/init/setupï¼‰å¯è¢«é‡å¤è°ƒç”¨**ï¼Œå¯¼è‡´ï¼š
- owner/admin/roles è¢«è¦†ç›–ï¼ˆå¤ºæƒï¼‰
- treasury/fee/oracle/router ç­‰å…³é”®å‚æ•°è¢«ç¯¡æ”¹
- è¿›ä¸€æ­¥è§¦å‘æå¸ã€å‡çº§ã€æƒé™æ»¥ç”¨ç­‰ä¸¥é‡åæœ

ç›®æ ‡ï¼š
1. å†™ä¸€ä¸ªâ€œååˆçº¦â€ï¼š`initialize()` å¯é‡å¤è°ƒç”¨  
2. å†™æ”»å‡»æµ‹è¯•ï¼šäºŒæ¬¡ `initialize()` è¦†ç›– owner/treasuryï¼Œå®Œæˆå¤ºæƒ  
3. å†™â€œå¥½åˆçº¦â€ï¼šç”¨ `initializer`ï¼ˆæˆ–æœ€å°é”ï¼‰ä¿®å¤ï¼Œç¡®ä¿åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡  
4. å¢è¡¥å®¡è®¡è§†è§’ Checklistï¼ˆçœŸå®å®¡è®¡/è¯„å®¡æ—¶æ€ä¹ˆå¿«é€Ÿæ‰«å‡ºé—®é¢˜ï¼‰

---

## æ ¸å¿ƒçŸ¥è¯†ç‚¹
### 1) ä¸ºä»€ä¹ˆå¯å‡çº§åˆçº¦ä¸ç”¨ constructor
åœ¨ Proxy æ¨¡å¼ä¸­ï¼š
- **çŠ¶æ€ï¼ˆstorageï¼‰åœ¨ Proxy åœ°å€ä¸Š**
- é€»è¾‘åˆçº¦ï¼ˆImplementation/Implï¼‰çš„ `constructor` åªåœ¨éƒ¨ç½² Impl æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå†™å…¥çš„æ˜¯ **Impl è‡ªå·±çš„ storage**
- ç”¨æˆ·äº¤äº’çš„æ˜¯ Proxyï¼ŒProxy é€šè¿‡ `delegatecall` æ‰§è¡Œ Impl ä»£ç ï¼Œä½†è¯»å†™çš„æ˜¯ **Proxy çš„ storage**

å› æ­¤ï¼Œå¿…é¡»ç”¨å¤–éƒ¨ `initialize()` æ¥åˆå§‹åŒ– Proxy çš„ storageã€‚

> å£è¯€ï¼š**constructor åˆå§‹åŒ–çš„æ˜¯ Implï¼›initialize åˆå§‹åŒ–çš„æ‰æ˜¯ Proxyï¼ˆdelegatecall å†™ Proxy å­˜å‚¨ï¼‰**ã€‚

### 2) æ¼æ´æœ¬è´¨ï¼šinitialize ç¼ºå°‘â€œä¸€æ¬¡æ€§é”â€
å¦‚æœ `initialize()`ï¼š
- æ²¡æœ‰ `initializer` / æ²¡æœ‰ç‰ˆæœ¬é” / æˆ–é”é€»è¾‘å†™é”™  
æ”»å‡»è€…å°±å¯èƒ½ï¼š
- æŠ¢å…ˆåˆå§‹åŒ–ï¼ˆéƒ¨ç½²åæœªåˆå§‹åŒ–çª—å£æœŸï¼‰
- æˆ– **é‡å¤åˆå§‹åŒ–**ï¼ˆè¦†ç›– owner/treasury ç­‰å…³é”®çŠ¶æ€ï¼‰

### 3) reinitializer(2) ä¸æ˜¯â€œå…è®¸åˆå§‹åŒ–ä¸¤æ¬¡â€
`reinitializer(2)` è¡¨ç¤º **åˆå§‹åŒ–é˜¶æ®µ/ç‰ˆæœ¬å·ä¸º 2 çš„åˆå§‹åŒ–å‡½æ•°**ï¼š
- åªèƒ½åœ¨å½“å‰åˆå§‹åŒ–ç‰ˆæœ¬ `< 2` æ—¶æ‰§è¡Œä¸€æ¬¡
- æˆåŠŸåæŠŠç‰ˆæœ¬æå‡ä¸º 2ï¼Œåç»­å†è°ƒç”¨ä¼š revert  
å¸¸ç”¨äºâ€œå‡çº§åˆ° V2 åæ–°å¢å˜é‡/æ¨¡å—çš„è¡¥ä¸åˆå§‹åŒ–â€ã€‚

---

## Step Aï¼šååˆçº¦ï¼ˆå¯é‡å¤ initï¼‰è®¾è®¡
**åç‚¹ï¼š** `initialize()` æ²¡æœ‰ä»»ä½•â€œä¸€æ¬¡æ€§â€ä¿æŠ¤ï¼Œä»»ä½•äººéƒ½èƒ½é‡å¤è°ƒç”¨è¦†ç›–å…³é”®çŠ¶æ€ã€‚

å…¸å‹å­—æ®µï¼š
- `owner`
- `treasury`
- `onlyOwner` çš„æ•æ„Ÿæ“ä½œï¼š`setTreasury()` / `sweepETH()`

> ç»“æœï¼šæ”»å‡»è€…äºŒæ¬¡ initialize -> owner å˜ attacker -> ç›´æ¥æ”¹ treasury / æèµ°èµ„é‡‘ã€‚

---

## Step Bï¼šæ”»å‡»æµ‹è¯•ï¼ˆå¤ç°æ¼æ´ï¼‰
### æ”»å‡»è·¯å¾„ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
1. æ­£å¸¸ç”¨æˆ· aliceï¼š`initialize(alice, aliceTreasury)`
2. æ”»å‡»è€… attackerï¼šå†æ¬¡ `initialize(attacker, attackerTreasury)`
3. owner/treasury è¢«è¦†ç›–
4. attacker è°ƒç”¨ onlyOwner å‡½æ•°ï¼ˆå¦‚ sweepETHï¼‰æŠŠåˆçº¦èµ„äº§è½¬èµ°

### æµ‹è¯•è¦ç‚¹
- ç”¨ `vm.prank(alice)` / `vm.prank(attacker)` åˆ‡æ¢ msg.sender
- ç”¨ `vm.deal(address(this), X)` ç»™â€œæ‰“æ¬¾äººâ€ä½™é¢
- ç”¨ `address(bad).call{value: ...}("")` æŠŠ ETH çœŸçš„æ‰“è¿›è¢«æµ‹åˆçº¦ï¼ˆ**address(this) â‰  address(bad)**ï¼‰
- æ–­è¨€ owner/treasury å˜åŒ–ä¸èµ„é‡‘å˜åŒ–

---

## Step Cï¼šå¥½åˆçº¦ï¼ˆinitializer ä¿®å¤ï¼‰
### ä¿®å¤åŸåˆ™
- `initialize(...) external initializer`ï¼š**ç¡®ä¿åªèƒ½æ‰§è¡Œä¸€æ¬¡**
- ï¼ˆå¯å‡çº§çœŸå®é¡¹ç›®ï¼‰å®ç°åˆçº¦ constructor é‡Œ ` _disableInitializers()`ï¼šé˜²æ­¢ Impl åœ°å€è‡ªèº«è¢«åˆå§‹åŒ–  
  - æ³¨æ„ï¼šå¦‚æœä½ ä»Šå¤©**ä¸å†™ Proxy**ã€ç›´æ¥ `new Impl()` æµ‹ initializeï¼Œé‚£ä¹ˆåŠ  `_disableInitializers()` ä¼šå¯¼è‡´ç¬¬ä¸€æ¬¡ initialize å°± revertï¼ˆä½ ä»Šå¤©é‡åˆ°çš„ `InvalidInitialization()` å°±æ˜¯è¿™ä¸ªåŸå› ï¼‰ã€‚

### ä»Šæ—¥è®­ç»ƒæ¨èæ–¹å¼ï¼ˆä¸å†™ Proxyï¼‰
- è®­ç»ƒâ€œåˆå§‹åŒ–é”â€çš„æ ¸å¿ƒæœºåˆ¶ï¼š**å…ˆä¸åŠ  `_disableInitializers()`**
- åç»­å¼•å…¥ Proxy åå†åŠ å›æ¥ï¼Œå¹¶åœ¨ Proxy ä¸Šåˆå§‹åŒ–ï¼ˆæœ€è´´è¿‘ç”Ÿäº§ï¼‰

---

## ä»Šæ—¥è¸©å‘è®°å½•ï¼šInvalidInitialization() çš„åŸå› ä¸ç»“è®º
ç°è±¡ï¼š`initialize()` ç¬¬ä¸€æ¬¡å°± revertï¼š`InvalidInitialization()`

åŸå› ï¼šå®ç°åˆçº¦é‡Œå†™äº†ï¼š
```solidity
constructor() { _disableInitializers(); }
```
è¿™ä¼šé”æ­» **å®ç°åˆçº¦åœ°å€ï¼ˆImplï¼‰è‡ªèº«** çš„åˆå§‹åŒ–ç‰ˆæœ¬å·ï¼Œæ‰€ä»¥ç›´æ¥å¯¹ Impl è°ƒç”¨ initialize ä¼šå¤±è´¥ã€‚

ç»“è®ºï¼š
- **ä¸å†™ Proxy çš„è®­ç»ƒ**ï¼šä¸è¦åŠ  `_disableInitializers()`ï¼ˆå¦åˆ™ä½ æµ‹ä¸åˆ° initializer çš„è¡Œä¸ºï¼‰
- **å†™ Proxy çš„çœŸå®å½¢æ€**ï¼šå¿…é¡»åŠ  `_disableInitializers()`ï¼Œå¹¶ä¸”é€šè¿‡ Proxyï¼ˆdelegatecallï¼‰æ¥æ‰§è¡Œ initialize

---

## Foundry è¿è¡Œæ–¹å¼
### è¿è¡Œååˆçº¦æ”»å‡»å¤ç°æµ‹è¯•
```bash
cd labs/foundry-labs
forge test --match-contract D17_BadInit_AttackTest -vvv
```

### è¿è¡Œå¥½åˆçº¦ï¼ˆinitializer ä¿®å¤ï¼‰æµ‹è¯•
```bash
cd labs/foundry-labs
forge test --match-contract D17_GoodInit_Test -vvv
```

---

## å®¡è®¡è§†è§’ Checklistï¼ˆå¼ºçƒˆå»ºè®®æ¯æ¬¡è¯„å®¡éƒ½è¿‡ä¸€éï¼‰
### A. åˆå§‹åŒ–å…¥å£è¯†åˆ«
- [ ] æ˜¯å¦å­˜åœ¨ `initialize/init/setup/config` ç­‰å‡½æ•°å¯ä¿®æ”¹å…³é”®çŠ¶æ€ï¼Ÿ
- [ ] æ˜¯å¦æ˜¯å¯å‡çº§æ¨¡å¼ï¼ˆProxy/delegatecallï¼‰æˆ–â€œå¯åˆå§‹åŒ–æ¨¡å¼â€ï¼ˆæ²¡æœ‰ constructor åˆå§‹åŒ–ï¼‰ï¼Ÿ

### B. ä¸€æ¬¡æ€§åˆå§‹åŒ–ä¿æŠ¤
- [ ] `initialize()` æ˜¯å¦ä½¿ç”¨ `initializer`ï¼ˆæˆ–ç­‰ä»·çš„ä¸€æ¬¡æ€§é”ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦å­˜åœ¨å¤šä¸ª init å‡½æ•°äº’ç›¸ç‹¬ç«‹çš„é”ï¼Œå¯¼è‡´å¯ç»„åˆç»•è¿‡ï¼Ÿ
- [ ] æ˜¯å¦å­˜åœ¨åˆ†æ”¯æ²¡æŠŠ `initialized = true` å†™å›ï¼ˆé”é€»è¾‘å†™é”™ï¼‰ï¼Ÿ

### C. å…³é”®çŠ¶æ€æ˜¯å¦å¯è¢« init è¦†ç›–
- [ ] init æ˜¯å¦è®¾ç½®/é‡ç½® `owner/admin/DEFAULT_ADMIN_ROLE`ï¼Ÿ
- [ ] init æ˜¯å¦å¯è¦†ç›– `treasury/feeReceiver/router/oracle/implementation admin` ç­‰å…³é”®é…ç½®ï¼Ÿ
- [ ] init æ˜¯å¦å…è®¸ä¼ å…¥ `address(0)`ï¼ˆå¯¼è‡´ä¸å¯ç”¨/æ°¸ä¹…é”æ­»/ç»•è¿‡ï¼‰ï¼Ÿ

### D. Proxy/éƒ¨ç½²æµç¨‹é£é™©ï¼ˆçª—å£æœŸï¼‰
- [ ] Proxy éƒ¨ç½²åæ˜¯å¦**åŒä¸€ç¬”äº¤æ˜“**å®Œæˆåˆå§‹åŒ–ï¼ˆæ„é€ å‚æ•° dataï¼‰ï¼Ÿ
- [ ] æ˜¯å¦å­˜åœ¨â€œå…ˆéƒ¨ç½² Proxyã€åè°ƒç”¨ initializeâ€çš„çª—å£æœŸå¯è¢«æŠ¢å…ˆåˆå§‹åŒ–ï¼Ÿ

### E. å®ç°åˆçº¦è‡ªèº«å®‰å…¨ï¼ˆç”Ÿäº§å»ºè®®ï¼‰
- [ ] å®ç°åˆçº¦ constructor æ˜¯å¦è°ƒç”¨ `_disableInitializers()`ï¼ˆé˜² Impl è¢«åˆå§‹åŒ–ï¼‰ï¼Ÿ
- [ ]ï¼ˆUUPSï¼‰å‡çº§å‡½æ•°æ˜¯å¦å— `onlyProxy` / `notDelegated` ç­‰çº¦æŸï¼ˆé˜²æ­¢è¯¯è°ƒç”¨/é”™è¯¯ä¸Šä¸‹æ–‡ï¼‰ï¼Ÿ

### F. å‡çº§åçš„äºŒé˜¶æ®µåˆå§‹åŒ–
- [ ] æ–°ç‰ˆæœ¬æ–°å¢å˜é‡/æ¨¡å—æ˜¯å¦æä¾› `reinitializer(n)` çš„ä¸€æ¬¡æ€§è¡¥ä¸åˆå§‹åŒ–ï¼Ÿ
- [ ] å‡çº§è„šæœ¬æ˜¯å¦åœ¨ upgrade åç«‹åˆ»è°ƒç”¨ V2 initï¼Œé¿å…é»˜è®¤å€¼å¼•å‘é£é™©ï¼Ÿ

---

## ä»Šæ—¥ç»“è®º
- åˆå§‹åŒ–æ¼æ´çš„æœ¬è´¨ï¼š**åˆå§‹åŒ–å…¥å£ç¼ºå°‘â€œä¸€æ¬¡æ€§é”â€** æˆ–éƒ¨ç½²æµç¨‹å­˜åœ¨æœªåˆå§‹åŒ–çª—å£æœŸ
- ä¿®å¤å…³é”®ï¼š`initializer` / `reinitializer(n)` +ï¼ˆç”Ÿäº§å½¢æ€ï¼‰`_disableInitializers()` + å®‰å…¨çš„éƒ¨ç½²/å‡çº§è„šæœ¬æµç¨‹
- Foundry æµ‹è¯•å¯ä»¥ç¨³å®šå¤ç°ä¸éªŒè¯ï¼šå¤ºæƒï¼ˆowner è¦†ç›–ï¼‰â†’ æ•æ„Ÿæ“ä½œï¼ˆsweep/æ”¹ treasuryï¼‰

---

## å»ºè®®çš„æ–‡ä»¶è½ä½ï¼ˆæŒ‰ä»“åº“é£æ ¼ï¼‰
- ğŸ“„ æ–‡æ¡£ï¼š`docs/2026/02/2026-02-11-D17-init-vuln-initializer.md`
- ğŸ“¦ ä»£ç ï¼š
  - `src/vulns/D17_BadInit.sol`
  - `src/vulns/D17_GoodInit.sol`
- ğŸ§ª æµ‹è¯•ï¼š
  - `test/vulns/D17_BadInit_AttackTest.t.sol`
  - `test/vulns/D17_GoodInit_Test.t.sol`
